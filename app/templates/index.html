<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthetic Data Generator</title>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // API base URL
        const API_BASE = '/api';

        // API helper
        const api = {
            get: async (endpoint) => {
                const res = await fetch(`${API_BASE}${endpoint}`);
                if (!res.ok) throw new Error((await res.json()).error || res.statusText);
                return res.json();
            },
            post: async (endpoint, data = {}) => {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!res.ok) throw new Error((await res.json()).error || res.statusText);
                return res.json();
            },
            put: async (endpoint, data = {}) => {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!res.ok) throw new Error((await res.json()).error || res.statusText);
                return res.json();
            },
            upload: async (endpoint, file) => {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    body: formData,
                });
                if (!res.ok) throw new Error((await res.json()).error || res.statusText);
                return res.json();
            },
        };

        // Components
        function Loader() {
            return <div className="flex justify-center p-4"><div className="loader"></div></div>;
        }

        function Alert({ type, message, onClose }) {
            const colors = {
                error: 'bg-red-100 border-red-400 text-red-700',
                success: 'bg-green-100 border-green-400 text-green-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700',
            };
            return (
                <div className={`${colors[type]} border px-4 py-3 rounded relative mb-4`}>
                    <span className="block sm:inline">{message}</span>
                    {onClose && (
                        <button onClick={onClose} className="absolute top-0 right-0 px-4 py-3">
                            <span className="text-xl">&times;</span>
                        </button>
                    )}
                </div>
            );
        }

        function DataTable({ data, maxRows = 10 }) {
            if (!data || data.length === 0) return <p className="text-gray-500">No data</p>;
            const columns = Object.keys(data[0]);
            const rows = data.slice(0, maxRows);

            return (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white border">
                        <thead className="bg-gray-100">
                            <tr>
                                {columns.map(col => (
                                    <th key={col} className="px-4 py-2 border text-left text-sm font-medium text-gray-700">
                                        {col}
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {rows.map((row, i) => (
                                <tr key={i} className="hover:bg-gray-50">
                                    {columns.map(col => (
                                        <td key={col} className="px-4 py-2 border text-sm text-gray-600">
                                            {String(row[col]).substring(0, 50)}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Sidebar Component
        function Sidebar({ appInfo, onConnect, onLoadSample, onFileUpload, onLoadTable, settings, setSettings, connectionInfo }) {
            const [connecting, setConnecting] = useState(false);
            const [databases, setDatabases] = useState([]);
            const [tables, setTables] = useState([]);
            const [selectedDb, setSelectedDb] = useState('');
            const [selectedTable, setSelectedTable] = useState('');
            const [tableInput, setTableInput] = useState('');
            const [loadingDbs, setLoadingDbs] = useState(false);
            const [loadingTables, setLoadingTables] = useState(false);
            const [loadingData, setLoadingData] = useState(false);

            const handleConnect = async (type) => {
                setConnecting(true);
                try {
                    await onConnect(type);
                } finally {
                    setConnecting(false);
                }
            };

            const handleDbChange = async (db) => {
                setSelectedDb(db);
                setSelectedTable('');
                setTables([]);
                if (db) {
                    setLoadingTables(true);
                    try {
                        const result = await api.get(`/tables/${db}`);
                        setTables(result.tables || []);
                    } catch (e) {
                        console.error('Failed to load tables:', e);
                    } finally {
                        setLoadingTables(false);
                    }
                }
            };

            const handleLoadTable = async () => {
                if (!selectedDb || !selectedTable) return;
                setLoadingData(true);
                try {
                    await onLoadTable(selectedDb, selectedTable);
                } finally {
                    setLoadingData(false);
                }
            };

            const handleLoadTableDirect = async () => {
                if (!tableInput.includes('.')) return;
                const [db, table] = tableInput.split('.', 2);
                setLoadingData(true);
                try {
                    await onLoadTable(db, table);
                } finally {
                    setLoadingData(false);
                }
            };

            return (
                <div className="w-72 min-w-72 flex-shrink-0 bg-white shadow-lg p-4 overflow-y-auto">
                    <div className="mb-6">
                        <h1 className="text-xl font-bold text-gray-800">Synthetic Data Generator</h1>
                        <p className="text-sm text-gray-500 mt-1">Generate privacy-safe data</p>
                    </div>

                    {/* Connection Status */}
                    {connectionInfo && (
                        <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                            <p className="text-sm font-medium text-green-800">Connected</p>
                            <p className="text-xs text-green-600">{connectionInfo.connection_type_label || connectionInfo.type}</p>
                            <p className="text-xs text-green-600">{connectionInfo.connection_name}</p>
                        </div>
                    )}

                    {/* Data Source */}
                    <div className="mb-6">
                        <h2 className="font-semibold text-gray-700 mb-3">Data Source</h2>

                        {!connectionInfo ? (
                            <>
                                {/* Demo Mode */}
                                <button
                                    onClick={() => handleConnect('demo')}
                                    disabled={connecting}
                                    className="w-full mb-2 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded disabled:opacity-50"
                                >
                                    {connecting ? 'Connecting...' : 'Connect Demo'}
                                </button>

                                {/* CML Connect */}
                                {appInfo?.cml_connector_available && (
                                    <button
                                        onClick={() => handleConnect('cml')}
                                        disabled={connecting}
                                        className="w-full mb-2 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded disabled:opacity-50"
                                    >
                                        Connect to Cloudera
                                    </button>
                                )}
                            </>
                        ) : connectionInfo.type === 'cml' ? (
                            /* Direct Table Input */
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">Table (database.table)</label>
                                    <input
                                        type="text"
                                        value={tableInput}
                                        onChange={(e) => setTableInput(e.target.value)}
                                        placeholder="default.my_table"
                                        className="w-full border rounded px-3 py-2 text-sm"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">Example: default.transactions_v2</p>
                                </div>

                                <button
                                    onClick={handleLoadTableDirect}
                                    disabled={loadingData || !tableInput.includes('.')}
                                    className="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded disabled:opacity-50"
                                >
                                    {loadingData ? 'Loading...' : 'Load Table'}
                                </button>
                            </div>
                        ) : null}

                        {/* Sample Data */}
                        <div className="mt-4">
                            <p className="text-sm text-gray-600 mb-2">Or load sample data:</p>
                            <div className="flex gap-2 flex-wrap">
                                {['customers', 'transactions', 'mixed'].map(type => (
                                    <button
                                        key={type}
                                        onClick={() => onLoadSample(type)}
                                        className="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded"
                                    >
                                        {type}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* CSV Upload */}
                        <div className="mt-4">
                            <p className="text-sm text-gray-600 mb-2">Or upload CSV:</p>
                            <input
                                type="file"
                                accept=".csv"
                                onChange={(e) => e.target.files[0] && onFileUpload(e.target.files[0])}
                                className="text-sm"
                            />
                        </div>
                    </div>

                    {/* Generation Settings */}
                    <div className="mb-6">
                        <h2 className="font-semibold text-gray-700 mb-3">Generation Settings</h2>

                        <label className="block text-sm text-gray-600 mb-1">Rows to Generate</label>
                        <input
                            type="number"
                            value={settings.nRows}
                            onChange={(e) => setSettings({...settings, nRows: parseInt(e.target.value)})}
                            min={10}
                            max={100000}
                            className="w-full border rounded px-3 py-2 mb-3"
                        />

                        <label className="block text-sm text-gray-600 mb-1">Generator Type</label>
                        <select
                            value={settings.generatorType}
                            onChange={(e) => setSettings({...settings, generatorType: e.target.value})}
                            className="w-full border rounded px-3 py-2 mb-3"
                        >
                            <option value="basic">Basic (Fast)</option>
                            {appInfo?.sdv_available && (
                                <>
                                    <option value="gaussian_copula">SDV Gaussian Copula</option>
                                    <option value="ctgan">SDV CTGAN</option>
                                </>
                            )}
                        </select>

                        <label className="block text-sm text-gray-600 mb-1">Random Seed</label>
                        <input
                            type="number"
                            value={settings.randomSeed}
                            onChange={(e) => setSettings({...settings, randomSeed: parseInt(e.target.value)})}
                            min={0}
                            className="w-full border rounded px-3 py-2"
                        />
                    </div>

                    {/* Status */}
                    <div className="text-xs text-gray-500">
                        <p>CML: {appInfo?.cml_environment ? 'Yes' : 'No'}</p>
                        <p>SDV: {appInfo?.sdv_available ? 'Available' : 'Not installed'}</p>
                        <p>LLM (Claude): {appInfo?.llm_available ? 'Available' : 'API key needed'}</p>
                    </div>
                </div>
            );
        }

        // Main Content Component
        function MainContent({ state, appInfo, onProfile, onGenerate, onDownload, onTokenize, onUseTokenizedAsSource }) {
            const [activeTab, setActiveTab] = useState('preview');

            const tabs = [
                { id: 'preview', label: 'Data Preview' },
                { id: 'profile', label: 'Profile' },
                { id: 'tokenize', label: 'Tokenize' },
                { id: 'generate', label: 'Generate' },
                { id: 'results', label: 'Results' },
            ];

            return (
                <div className="flex-1 p-6 overflow-auto">
                    {/* Tabs */}
                    <div className="border-b mb-6">
                        <nav className="flex gap-4">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`py-2 px-4 ${
                                        activeTab === tab.id
                                            ? 'border-b-2 border-blue-500 text-blue-600'
                                            : 'text-gray-500 hover:text-gray-700'
                                    }`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </nav>
                    </div>

                    {/* Tab Content */}
                    {activeTab === 'preview' && (
                        <PreviewTab data={state.sourceData} />
                    )}
                    {activeTab === 'profile' && (
                        <ProfileTab
                            profile={state.profile}
                            columnConfig={state.columnConfig}
                            onProfile={onProfile}
                            hasData={!!state.sourceData}
                        />
                    )}
                    {activeTab === 'tokenize' && (
                        <TokenizeTab
                            hasData={!!state.sourceData}
                            tokenizedData={state.tokenizedData}
                            llmAvailable={appInfo?.llm_available}
                            onTokenize={onTokenize}
                            onUseAsSource={onUseTokenizedAsSource}
                        />
                    )}
                    {activeTab === 'generate' && (
                        <GenerateTab
                            hasData={!!state.sourceData}
                            onGenerate={onGenerate}
                            generating={state.generating}
                        />
                    )}
                    {activeTab === 'results' && (
                        <ResultsTab
                            syntheticData={state.syntheticData}
                            comparison={state.comparison}
                            onDownload={onDownload}
                        />
                    )}
                </div>
            );
        }

        function PreviewTab({ data }) {
            if (!data) {
                return (
                    <div className="text-center py-12">
                        <h2 className="text-xl font-semibold text-gray-700 mb-2">No Data Loaded</h2>
                        <p className="text-gray-500">Connect to a data source or upload a CSV file</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="flex gap-4 mb-4">
                        <div className="bg-white p-4 rounded shadow">
                            <p className="text-sm text-gray-500">Rows</p>
                            <p className="text-2xl font-bold">{data.rows?.toLocaleString()}</p>
                        </div>
                        <div className="bg-white p-4 rounded shadow">
                            <p className="text-sm text-gray-500">Columns</p>
                            <p className="text-2xl font-bold">{data.columns?.length}</p>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded shadow">
                        <h3 className="font-semibold mb-3">Data Preview</h3>
                        <DataTable data={data.preview} />
                    </div>

                    <div className="bg-white p-4 rounded shadow mt-4">
                        <h3 className="font-semibold mb-3">Column Types</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {data.columns?.map(col => (
                                <div key={col} className="text-sm p-2 bg-gray-50 rounded">
                                    <span className="font-medium">{col}</span>
                                    <span className="text-gray-500 ml-2">{data.dtypes?.[col]}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function ProfileTab({ profile, columnConfig, onProfile, hasData }) {
            const [profiling, setProfiling] = useState(false);

            const handleProfile = async () => {
                setProfiling(true);
                try {
                    await onProfile();
                } finally {
                    setProfiling(false);
                }
            };

            if (!hasData) {
                return <div className="text-center py-12 text-gray-500">Load data first</div>;
            }

            return (
                <div>
                    <button
                        onClick={handleProfile}
                        disabled={profiling}
                        className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded mb-4 disabled:opacity-50"
                    >
                        {profiling ? 'Profiling...' : 'Profile Data'}
                    </button>

                    {profile && (
                        <div className="space-y-4">
                            {/* Overview */}
                            <div className="bg-white p-4 rounded shadow">
                                <h3 className="font-semibold mb-3">Overview</h3>
                                <div className="grid grid-cols-4 gap-4">
                                    <div>
                                        <p className="text-sm text-gray-500">Rows</p>
                                        <p className="text-xl font-bold">{profile.overview?.n_rows?.toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Columns</p>
                                        <p className="text-xl font-bold">{profile.overview?.n_columns}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Missing Values</p>
                                        <p className="text-xl font-bold">{profile.overview?.total_missing?.toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Duplicates</p>
                                        <p className="text-xl font-bold">{profile.overview?.duplicate_rows}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Column Details */}
                            <div className="bg-white p-4 rounded shadow">
                                <h3 className="font-semibold mb-3">Column Profiles</h3>
                                <div className="space-y-2">
                                    {Object.entries(profile.columns || {}).map(([col, info]) => (
                                        <div key={col} className="border rounded p-3">
                                            <div className="flex justify-between items-center">
                                                <span className="font-medium">{col}</span>
                                                <span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                                    {info.detected_type}
                                                </span>
                                            </div>
                                            <div className="text-sm text-gray-500 mt-1">
                                                <span>Non-null: {info.statistics?.count - info.statistics?.null_count}</span>
                                                <span className="ml-4">Unique: {info.statistics?.unique_count}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function TokenizeTab({ hasData, tokenizedData, llmAvailable, onTokenize, onUseAsSource }) {
            const [secretKey, setSecretKey] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [sensitiveColumns, setSensitiveColumns] = useState({});
            const [selectedColumns, setSelectedColumns] = useState({});
            const [detecting, setDetecting] = useState(false);
            const [tokenizing, setTokenizing] = useState(false);
            const [useLlm, setUseLlm] = useState(false);
            const [comparison, setComparison] = useState([]);
            const [detectionMethod, setDetectionMethod] = useState(null);

            const dataTypes = [
                { value: 'credit_card', label: 'Credit Card' },
                { value: 'ssn', label: 'SSN' },
                { value: 'phone', label: 'Phone' },
                { value: 'email', label: 'Email' },
                { value: 'name', label: 'Name' },
                { value: 'date', label: 'Date' },
                { value: 'address', label: 'Address' },
                { value: 'alphanumeric', label: 'Alphanumeric' },
            ];

            const handleGenerateKey = async () => {
                try {
                    const result = await api.post('/tokenize/generate-key');
                    setSecretKey(result.key);
                } catch (e) {
                    alert('Error generating key: ' + e.message);
                }
            };

            const handleDetect = async () => {
                setDetecting(true);
                try {
                    const result = await api.post('/tokenize/detect', {
                        use_llm: useLlm,
                        api_key: apiKey || undefined,
                    });
                    setSensitiveColumns(result.sensitive_columns);
                    setSelectedColumns(result.sensitive_columns);
                    setDetectionMethod(result.detection_method);
                } catch (e) {
                    alert('Error detecting columns: ' + e.message);
                } finally {
                    setDetecting(false);
                }
            };

            const handleColumnToggle = (col) => {
                setSelectedColumns(prev => {
                    const newSelected = {...prev};
                    if (newSelected[col]) {
                        delete newSelected[col];
                    } else {
                        newSelected[col] = sensitiveColumns[col] || 'alphanumeric';
                    }
                    return newSelected;
                });
            };

            const handleTypeChange = (col, type) => {
                setSelectedColumns(prev => ({...prev, [col]: type}));
            };

            const handleTokenize = async () => {
                if (!secretKey) {
                    alert('Please enter or generate a secret key');
                    return;
                }
                if (Object.keys(selectedColumns).length === 0) {
                    alert('Please select columns to tokenize');
                    return;
                }

                setTokenizing(true);
                try {
                    const result = await onTokenize(secretKey, selectedColumns);
                    if (result.comparison) {
                        setComparison(result.comparison);
                    }
                } finally {
                    setTokenizing(false);
                }
            };

            const handleDownloadTokenized = (format) => {
                window.open(`/api/tokenize/download/${format}`, '_blank');
            };

            if (!hasData) {
                return <div className="text-center py-12 text-gray-500">Load data first</div>;
            }

            return (
                <div className="space-y-6">
                    {/* Key Management */}
                    <div className="bg-white p-4 rounded shadow">
                        <h3 className="font-semibold mb-3">Encryption Key</h3>
                        <p className="text-sm text-gray-500 mb-3">
                            The secret key is used to encrypt sensitive data. Save this key securely - you'll need it to decrypt the data later.
                        </p>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={secretKey}
                                onChange={(e) => setSecretKey(e.target.value)}
                                placeholder="Enter or generate a secret key..."
                                className="flex-1 border rounded px-3 py-2 font-mono text-sm"
                            />
                            <button
                                onClick={handleGenerateKey}
                                className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded"
                            >
                                Generate Key
                            </button>
                        </div>
                    </div>

                    {/* Column Detection */}
                    <div className="bg-white p-4 rounded shadow">
                        <h3 className="font-semibold mb-3">Detect Sensitive Columns</h3>

                        {/* LLM Option */}
                        <div className="mb-4">
                            <label className="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    checked={useLlm}
                                    onChange={(e) => setUseLlm(e.target.checked)}
                                    className="rounded"
                                />
                                <span className="text-sm">Use AI (Claude) for smart detection</span>
                                {llmAvailable && <span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">Available</span>}
                            </label>

                            {useLlm && (
                                <div className="mt-2 ml-6">
                                    <label className="block text-sm text-gray-600 mb-1">Anthropic API Key (optional if set in env)</label>
                                    <input
                                        type="password"
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="sk-ant-..."
                                        className="w-full max-w-md border rounded px-3 py-2 text-sm"
                                    />
                                </div>
                            )}
                        </div>

                        <button
                            onClick={handleDetect}
                            disabled={detecting}
                            className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded disabled:opacity-50"
                        >
                            {detecting ? 'Detecting...' : 'Detect Sensitive Columns'}
                        </button>

                        {detectionMethod && (
                            <span className="ml-4 text-sm text-gray-500">
                                Method: <span className="font-medium">{detectionMethod === 'llm' ? 'AI (Claude)' : 'Rule-based'}</span>
                            </span>
                        )}
                    </div>

                    {/* Column Selection */}
                    {Object.keys(sensitiveColumns).length > 0 && (
                        <div className="bg-white p-4 rounded shadow">
                            <h3 className="font-semibold mb-3">Select Columns to Tokenize</h3>
                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                {Object.entries(sensitiveColumns).map(([col, detectedType]) => (
                                    <div key={col} className="flex items-center gap-3 p-2 border rounded">
                                        <input
                                            type="checkbox"
                                            checked={!!selectedColumns[col]}
                                            onChange={() => handleColumnToggle(col)}
                                            className="rounded"
                                        />
                                        <span className="flex-1 font-medium">{col}</span>
                                        <select
                                            value={selectedColumns[col] || detectedType}
                                            onChange={(e) => handleTypeChange(col, e.target.value)}
                                            disabled={!selectedColumns[col]}
                                            className="border rounded px-2 py-1 text-sm"
                                        >
                                            {dataTypes.map(dt => (
                                                <option key={dt.value} value={dt.value}>{dt.label}</option>
                                            ))}
                                        </select>
                                        <span className="text-xs text-gray-400">detected: {detectedType}</span>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-4">
                                <button
                                    onClick={handleTokenize}
                                    disabled={tokenizing || !secretKey || Object.keys(selectedColumns).length === 0}
                                    className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded disabled:opacity-50"
                                >
                                    {tokenizing ? 'Tokenizing...' : 'Tokenize Selected Columns'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Tokenization Preview */}
                    {comparison.length > 0 && (
                        <div className="bg-white p-4 rounded shadow">
                            <h3 className="font-semibold mb-3">Tokenization Preview (Before/After)</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full border">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="px-4 py-2 border">Column</th>
                                            <th className="px-4 py-2 border">Original</th>
                                            <th className="px-4 py-2 border">Tokenized</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {comparison.map((row, i) => (
                                            <tr key={i}>
                                                <td className="px-4 py-2 border font-medium">{row.column}</td>
                                                <td className="px-4 py-2 border text-red-600 font-mono text-sm">{row.original}</td>
                                                <td className="px-4 py-2 border text-green-600 font-mono text-sm">{row.tokenized}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Tokenized Data Actions */}
                    {tokenizedData && (
                        <div className="bg-white p-4 rounded shadow">
                            <h3 className="font-semibold mb-3">Tokenized Data</h3>
                            <div className="flex gap-4 mb-4">
                                <div className="bg-gray-50 p-3 rounded">
                                    <p className="text-sm text-gray-500">Rows</p>
                                    <p className="text-xl font-bold">{tokenizedData.rows?.toLocaleString()}</p>
                                </div>
                                <div className="bg-gray-50 p-3 rounded">
                                    <p className="text-sm text-gray-500">Tokenized Columns</p>
                                    <p className="text-xl font-bold">{tokenizedData.columns_tokenized?.length || 0}</p>
                                </div>
                            </div>

                            <div className="mb-4">
                                <DataTable data={tokenizedData.preview} maxRows={5} />
                            </div>

                            <div className="flex gap-4 flex-wrap">
                                <button
                                    onClick={() => handleDownloadTokenized('csv')}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
                                >
                                    Download CSV
                                </button>
                                <button
                                    onClick={() => handleDownloadTokenized('parquet')}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
                                >
                                    Download Parquet
                                </button>
                                <button
                                    onClick={onUseAsSource}
                                    className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded"
                                >
                                    Use as Source for Synthetic Generation
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function GenerateTab({ hasData, onGenerate, generating }) {
            if (!hasData) {
                return <div className="text-center py-12 text-gray-500">Load data first</div>;
            }

            return (
                <div className="text-center py-12">
                    <h2 className="text-xl font-semibold mb-4">Generate Synthetic Data</h2>
                    <p className="text-gray-500 mb-6">Click the button below to generate synthetic data based on your settings</p>
                    <button
                        onClick={onGenerate}
                        disabled={generating}
                        className="bg-green-500 hover:bg-green-600 text-white py-3 px-8 rounded-lg text-lg disabled:opacity-50"
                    >
                        {generating ? 'Generating...' : 'Generate Synthetic Data'}
                    </button>
                </div>
            );
        }

        function ResultsTab({ syntheticData, comparison, onDownload }) {
            if (!syntheticData) {
                return <div className="text-center py-12 text-gray-500">Generate synthetic data first</div>;
            }

            return (
                <div className="space-y-4">
                    {/* Summary */}
                    <div className="flex gap-4 mb-4">
                        <div className="bg-white p-4 rounded shadow">
                            <p className="text-sm text-gray-500">Synthetic Rows</p>
                            <p className="text-2xl font-bold">{syntheticData.rows?.toLocaleString()}</p>
                        </div>
                        <div className="bg-white p-4 rounded shadow">
                            <p className="text-sm text-gray-500">Columns</p>
                            <p className="text-2xl font-bold">{syntheticData.columns?.length}</p>
                        </div>
                    </div>

                    {/* Preview */}
                    <div className="bg-white p-4 rounded shadow">
                        <h3 className="font-semibold mb-3">Synthetic Data Preview</h3>
                        <DataTable data={syntheticData.preview} />
                    </div>

                    {/* Comparison */}
                    {comparison && (
                        <div className="bg-white p-4 rounded shadow">
                            <h3 className="font-semibold mb-3">Statistical Comparison</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full border">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="px-4 py-2 border">Column</th>
                                            <th className="px-4 py-2 border">Original Mean/Unique</th>
                                            <th className="px-4 py-2 border">Synthetic Mean/Unique</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {comparison.map(row => (
                                            <tr key={row.column}>
                                                <td className="px-4 py-2 border font-medium">{row.column}</td>
                                                <td className="px-4 py-2 border">
                                                    {row.orig_mean !== undefined
                                                        ? row.orig_mean?.toFixed(2)
                                                        : row.orig_unique}
                                                </td>
                                                <td className="px-4 py-2 border">
                                                    {row.synth_mean !== undefined
                                                        ? row.synth_mean?.toFixed(2)
                                                        : row.synth_unique}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Download */}
                    <div className="bg-white p-4 rounded shadow">
                        <h3 className="font-semibold mb-3">Download</h3>
                        <div className="flex gap-4">
                            <button
                                onClick={() => onDownload('csv')}
                                className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded"
                            >
                                Download CSV
                            </button>
                            <button
                                onClick={() => onDownload('parquet')}
                                className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded"
                            >
                                Download Parquet
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [appInfo, setAppInfo] = useState(null);
            const [connectionInfo, setConnectionInfo] = useState(null);
            const [state, setState] = useState({
                sourceData: null,
                profile: null,
                columnConfig: null,
                syntheticData: null,
                comparison: null,
                generating: false,
                tokenizedData: null,
            });
            const [settings, setSettings] = useState({
                nRows: 1000,
                generatorType: 'basic',
                randomSeed: 42,
            });
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/info')
                    .then(setAppInfo)
                    .catch(e => setError(e.message))
                    .finally(() => setLoading(false));
            }, []);

            const handleConnect = async (type) => {
                try {
                    setError(null);
                    let connResult;
                    if (type === 'demo') {
                        connResult = await api.post('/connect/demo');
                    } else if (type === 'cml') {
                        connResult = await api.post('/connect/cml');
                    }
                    setConnectionInfo(connResult);
                    // Refresh info
                    const info = await api.get('/info');
                    setAppInfo(info);
                } catch (e) {
                    setError(e.message);
                }
            };

            const handleLoadTable = async (database, table) => {
                try {
                    setError(null);
                    const data = await api.post(`/table/${database}/${table}/load`, { limit: 200 });
                    setState(s => ({...s, sourceData: data, profile: null, syntheticData: null, tokenizedData: null}));
                } catch (e) {
                    setError(e.message);
                }
            };

            const handleLoadSample = async (type) => {
                try {
                    setError(null);
                    const data = await api.post(`/sample/${type}`);
                    setState(s => ({...s, sourceData: data, profile: null, syntheticData: null}));
                } catch (e) {
                    setError(e.message);
                }
            };

            const handleFileUpload = async (file) => {
                try {
                    setError(null);
                    const data = await api.upload('/upload/csv', file);
                    setState(s => ({...s, sourceData: data, profile: null, syntheticData: null}));
                } catch (e) {
                    setError(e.message);
                }
            };

            const handleProfile = async () => {
                try {
                    setError(null);
                    const data = await api.post('/profile');
                    setState(s => ({...s, profile: data.profile, columnConfig: data.column_config}));
                } catch (e) {
                    setError(e.message);
                }
            };

            const handleGenerate = async () => {
                try {
                    setError(null);
                    setState(s => ({...s, generating: true}));
                    const data = await api.post('/generate', {
                        n_rows: settings.nRows,
                        generator_type: settings.generatorType,
                        random_seed: settings.randomSeed,
                    });
                    // Get comparison
                    const comparison = await api.get('/compare/stats');
                    setState(s => ({
                        ...s,
                        syntheticData: data,
                        comparison: comparison.comparison,
                        generating: false,
                    }));
                } catch (e) {
                    setError(e.message);
                    setState(s => ({...s, generating: false}));
                }
            };

            const handleDownload = (format) => {
                window.open(`${API_BASE}/synthetic/download/${format}`, '_blank');
            };

            const handleTokenize = async (secretKey, columnTypes) => {
                try {
                    setError(null);
                    const result = await api.post('/tokenize', {
                        secret_key: secretKey,
                        column_types: columnTypes,
                    });
                    setState(s => ({...s, tokenizedData: result}));
                    return result;
                } catch (e) {
                    setError(e.message);
                    throw e;
                }
            };

            const handleUseTokenizedAsSource = async () => {
                try {
                    setError(null);
                    const result = await api.post('/tokenize/use-as-source');
                    // Refresh source data
                    setState(s => ({
                        ...s,
                        sourceData: {
                            ...s.sourceData,
                            rows: result.rows,
                            columns: result.columns,
                        },
                        profile: null,
                        syntheticData: null,
                        comparison: null,
                    }));
                    // Refresh info
                    const info = await api.get('/info');
                    setAppInfo(info);
                    alert('Tokenized data is now the source for synthetic generation');
                } catch (e) {
                    setError(e.message);
                }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <Loader />
                    </div>
                );
            }

            return (
                <div className="flex h-screen">
                    <Sidebar
                        appInfo={appInfo}
                        connectionInfo={connectionInfo}
                        onConnect={handleConnect}
                        onLoadSample={handleLoadSample}
                        onFileUpload={handleFileUpload}
                        onLoadTable={handleLoadTable}
                        settings={settings}
                        setSettings={setSettings}
                    />
                    <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                        {error && (
                            <div className="p-4">
                                <Alert type="error" message={error} onClose={() => setError(null)} />
                            </div>
                        )}
                        <MainContent
                            state={state}
                            appInfo={appInfo}
                            onProfile={handleProfile}
                            onGenerate={handleGenerate}
                            onDownload={handleDownload}
                            onTokenize={handleTokenize}
                            onUseTokenizedAsSource={handleUseTokenizedAsSource}
                        />
                    </div>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
